/* indexed-cache - v0.4.0
* Kailash Nadh. Licensed MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).IndexedCache=t()}(this,(function(){"use strict";function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function t(e,t,r,n,o,a,s){try{var i=e[a](s),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}function r(e){return function(){var r=this,n=arguments;return new Promise((function(o,a){var s=e.apply(r,n);function i(e){t(s,o,a,i,c,"next",e)}function c(e){t(s,o,a,i,c,"throw",e)}i(void 0)}))}}function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let o=!1;return class{constructor(t){if(o)throw new Error("indexed-cache is already loaded");o=!0,this.opt=function(t){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?e(Object(o),!0).forEach((function(e){n(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}({tags:["script","img","link"],dbName:"indexed-cache",storeName:"objects",prune:!1,expiry:131400},t),this.db=null}init(){var e=this;return r((function*(){e.db||(yield e._initDB(e.opt.dbName,e.opt.storeName).then((t=>{e.db=t})).catch((e=>{console.log("error initializing cache DB. failing over.",e)})))}))()}load(e){var t=this;return r((function*(){let r=[];if(yield t._setupElements(e).then((e=>{r=e})),t.db&&0!==r.length&&t.opt.prune){const e=r.map((e=>e.key));t._prune(e)}}))()}deleteKey(e){this._store().delete(e)}prune(e){this._prune(e)}clear(){this._store().clear()}_initDB(e,t){var n=this;return r((function*(){return new Promise(((r,o)=>{window.indexedDB||o(new Error("indexedDB is not available"));const a=window.indexedDB.open(e);a.onupgradeneeded=e=>{const n=e.target.result;e.target.result.objectStoreNames.contains(t)||(n.createObjectStore(t,{keyPath:"key"}),e.target.transaction.oncomplete=()=>{r(n)})},a.onsuccess=()=>r(a.result),a.onerror=e=>o(e.target.error),setTimeout((()=>{n.db||o(new Error("Opening IndexedbDB timed out"))}),200)}))}))()}_setupElements(e){var t=this;return r((function*(){const r=[];if(e instanceof NodeList)e=Array.from(e);else if(e instanceof Node)e=[e];else{const r=t.opt.tags.map((e=>`${e}[data-src]:not([data-indexed])`)).join(",");e=document.querySelectorAll(r)}e.forEach((e=>{if("indexed"in e.dataset)return;const n={el:e,key:e.dataset.key||e.dataset.src,src:e.dataset.src,hash:e.dataset.hash||e.dataset.src,isAsync:"SCRIPT"!==e.tagName||e.hasAttribute("async")||e.hasAttribute("defer"),expiry:null},o=e.dataset.expiry||t.opt.expiry;o&&(n.expiry=new Date((new Date).getTime()+6e4*parseInt(o))),t.db?r.push(n):t._applyElement(n)}));const n=[];return r.forEach((e=>{e.isAsync?t._getObject(e).then((r=>{t._applyElement(e,r.data.blob)})).catch((r=>{t._applyElement(e)})):n.push(t._getObject(e))})),0===n.length||(yield Promise.allSettled(n).then((e=>{e.forEach(((n,o)=>{"rejected"!==n.status?o>=e.length-1||(n.value.obj.el.onload=n.value.obj.el.onerror=()=>{t._applyElement(e[o+1].value.obj,e[o+1].value.data.blob)}):t._applyElement(r[o])})),t._applyElement(e[0].value.obj,e[0].value.data.blob)}))),r}))()}_getObject(e){return new Promise(((t,r)=>{this._getDBblob(e).then((r=>{t({obj:e,data:r})})).catch((r=>{"Error"!==r.toString()&&console.log("error getting cache blob:",r),this._fetchObject(e).then((r=>{t({obj:e,data:r})})).catch((r=>{t({obj:e,data:{key:e.key,hash:e.hash,expiry:e.expiry,blob:null}})}))}))}))}_getDBblob(e){return new Promise(((t,r)=>{try{const n=this._store().get(e.key);n.onsuccess=n=>{const o=n.target.result;if(o&&(!e.hash||o.hash===e.hash))return o.expiry&&new Date>new Date(o.expiry)?(this.deleteKey(o.key),void r(new Error(""))):void t(o);r(new Error(""))},n.onerror=e=>{r(e.target.error)}}catch(e){r(e.target.error)}}))}_fetchObject(e){return new Promise(((t,r)=>{fetch(e.src).then((n=>{n.ok?n.blob().then((n=>{const o={key:e.key,hash:e.hash,expiry:e.expiry,blob:n};try{const e=this._store().put(o);e.onsuccess=()=>t(o),e.onerror=e=>r(e.target.error)}catch(e){r(e)}})):r(new Error(`error fetching asset: ${n.status}`))})).catch((e=>r(e)))}))}_applyElement(e,t){let r=e.src;switch(t&&(r=window.URL.createObjectURL(t)),e.el.tagName){case"SCRIPT":case"IMG":e.el.src=r;break;case"LINK":e.el.href=r}e.el.dataset.indexed=!0}_prune(e){const t=e.reduce(((e,t)=>(e[t]=!0,e)),{});this._store().getAllKeys().onsuccess=e=>{e.target.result.forEach((e=>{e in t||this.deleteKey(e)}))}}_store(){return this.db.transaction(this.opt.storeName,"readwrite").objectStore(this.opt.storeName)}}}));
